# 危废转移订单模块开发总结

## 概述

根据数据库表 `waste_transfer_order` 的结构，按照 ruoyi-vue-pro 规范创建了完整的危废转移订单管理功能模块。该模块是危废处理业务的核心，负责管理从预约到最终结算的完整订单生命周期。

## 数据库表结构

表名：`waste_transfer_order`

主要字段：
- `id`: 订单ID（主键）
- `order_no`: 订单号（系统生成，唯一）
- `appointment_id`: 关联预约单ID
- `quotation_id`: 关联报价记录ID
- `producing_enterprise_id`: 产废企业ID
- `producing_store_id`: 产废门店ID
- `recycling_enterprise_id`: 回收企业ID
- `transport_task_id`: 关联的物流运输任务ID
- `vehicle_weighing_id`: 关联的车辆过磅ID
- `logistics_status`: 物流状态快照
- `waste_code`: 危险废物代码
- `waste_name`: 危险废物名称
- `estimated_quantity`: 预估数量
- `confirmed_quantity`: 收运员确认数量
- `allocated_quantity`: 基于过磅的分摊数量
- `quantity_unit`: 数量单位
- `packaging_type`: 包装方式
- `unit_price`: 单价
- `estimated_amount`: 预估总金额
- `final_amount`: 最终结算金额
- `business_status`: 业务状态
- `payment_config_id`: 关联的产废企业付款配置ID
- `payment_method_type`: 实际付款方式
- `payment_status`: 付款状态
- `payment_completed_time`: 付款完成时间
- `payment_voucher_id`: 对公付款凭证ID
- `pickup_confirmed_time`: 收货确认时间
- `pickup_confirmed_by`: 收货确认人
- `pickup_confirmed_location`: 收货确认GPS位置
- `allocation_ratio`: 在车辆总重量中的分摊比例
- `allocation_completed_time`: 订单分摊完成时间
- `variance_from_estimate`: 与预估量的差异
- `variance_rate`: 差异率
- `source_type`: 订单来源类型
- `related_order_id`: 关联订单ID（用于补单场景）
- `user_remark`: 用户备注
- `internal_remark`: 内部备注
- `tenant_id`: 租户ID

## 业务场景

危废转移订单表用于管理危险废物转移处理的完整业务流程：

1. **订单创建**：从预约单转换或直接创建订单
2. **数量确认**：收运员现场确认实际数量
3. **物流协作**：与物流模块协作进行运输管理
4. **过磅分摊**：基于车辆过磅数据进行数量和金额分摊
5. **付款管理**：支持多种付款方式和状态跟踪
6. **结算完成**：最终结算和订单完成

## 创建的代码文件

### 1. 枚举类

#### OrderBusinessStatusEnum.java
订单业务状态枚举，包含以下状态：
- PENDING_CONFIRM(0, "待确认")
- CONFIRMED(1, "已确认")
- PENDING_SETTLEMENT(2, "待结算")
- SETTLED(3, "已结算")
- COMPLETED(4, "已完成")
- CANCELLED(5, "已取消")

#### PaymentMethodTypeEnum.java
付款方式类型枚举，包含以下类型：
- CORPORATE_SETTLEMENT(1, "对公结算")
- PERSONAL_SETTLEMENT(2, "个人结算")

#### PaymentStatusEnum.java
付款状态枚举，包含以下状态：
- UNPAID(0, "未付款")
- PAID(1, "已付款")
- PAYMENT_FAILED(2, "付款失败")
- PENDING_VOUCHER_UPLOAD(3, "待凭证上传")
- VOUCHER_UPLOADED(4, "凭证已上传")
- VOUCHER_CONFIRMED(5, "凭证已确认")

#### OrderSourceTypeEnum.java
订单来源类型枚举，包含以下类型：
- APPOINTMENT_TO_ORDER(0, "预约转订单")
- STREET_SWEEPING_ORDER(1, "扫街临时订单")
- SUPPLEMENTARY_ORDER(2, "补单")

#### AllocationMethodEnum.java
分摊方法枚举，包含以下方法：
- BY_ESTIMATED_RATIO(1, "按预估量比例")
- BY_CONFIRMED_RATIO(2, "按确认量比例")
- MANUAL_SPECIFIED(3, "人工指定")
- AVERAGE_ALLOCATION(4, "平均分摊")

### 2. 数据对象 (DO)

#### TransferOrderDO.java
与数据库表一一对应的数据对象，包含所有数据库字段，继承自 `BaseDO`。

#### OrderAllocationRecordDO.java
订单过磅分摊记录数据对象，用于记录订单在车辆过磅时的分摊计算过程。

#### OrderPriceAdjustmentDO.java
订单价格调整记录数据对象，用于记录订单价格和数量的调整历史。

#### OrderStatusHistoryDO.java
订单状态变更历史数据对象，用于记录订单状态的完整变更轨迹。

### 3. 数据访问层 (Mapper)

#### TransferOrderMapper.java
数据访问接口，继承自 `BaseMapperX`，提供以下查询方法：
- `selectPage()`: 分页查询
- `selectList()`: 列表查询
- `selectByOrderNo()`: 根据订单号查询
- `selectByAppointmentId()`: 根据预约单ID查询
- `selectByProducingEnterpriseId()`: 根据产废企业ID查询
- `selectByRecyclingEnterpriseId()`: 根据回收企业ID查询
- `selectByBusinessStatus()`: 根据业务状态查询
- `selectByPaymentStatus()`: 根据付款状态查询
- `selectByWasteCode()`: 根据废物代码查询
- `selectBySourceType()`: 根据订单来源类型查询

#### OrderAllocationRecordMapper.java
订单分摊记录数据访问接口，提供分摊记录的查询和管理功能。

#### OrderPriceAdjustmentMapper.java
订单价格调整记录数据访问接口，提供价格调整记录的查询和管理功能。

#### OrderStatusHistoryMapper.java
订单状态历史数据访问接口，提供状态变更历史的查询功能。

### 4. VO 类

#### TransferOrderCreateReqVO.java
创建危废转移订单的请求对象，包含完整的校验注解：
- 企业ID必填校验
- 废物代码和名称校验
- 数量和金额格式校验
- 字段长度校验

#### TransferOrderUpdateReqVO.java
更新危废转移订单的请求对象，继承自 `TransferOrderCreateReqVO`，增加了 `id` 字段。

#### TransferOrderPageReqVO.java
分页查询请求对象，继承自 `PageParam`，包含各种查询条件。

#### TransferOrderRespVO.java
危废转移订单响应对象，包含所有字段和状态名称等扩展字段。

#### TransferOrderExcelVO.java
Excel 导出对象，使用 `@ExcelProperty` 注解标注各字段。

### 5. 转换器 (Convert)

#### TransferOrderConvert.java
使用 MapStruct 实现的对象转换器，提供以下转换方法：
- DO 与 VO 之间的转换
- 业务状态值转状态名称
- 付款状态值转状态名称
- 订单来源类型值转类型名称
- 列表和分页结果的转换

### 6. 业务逻辑层 (Service)

#### TransferOrderService.java
业务逻辑接口，定义了完整的危废转移订单管理功能：

**基础 CRUD 操作：**
- `createTransferOrder()`: 创建危废转移订单
- `updateTransferOrder()`: 更新危废转移订单
- `deleteTransferOrder()`: 删除危废转移订单
- `getTransferOrder()`: 获取危废转移订单
- `getTransferOrderDetail()`: 获取危废转移订单详情
- `getTransferOrderPage()`: 分页查询危废转移订单

**查询方法：**
- `getTransferOrderByNo()`: 根据订单号查询
- `getTransferOrderListByAppointmentId()`: 根据预约单ID查询
- `getTransferOrderListByEnterpriseId()`: 根据企业ID查询
- `getTransferOrderListByBusinessStatus()`: 根据业务状态查询
- `getTransferOrderListByPaymentStatus()`: 根据付款状态查询
- `getTransferOrderListByWasteCode()`: 根据废物代码查询

**业务流程方法：**
- `confirmOrder()`: 确认订单
- `confirmPickup()`: 确认收货
- `allocateQuantity()`: 分摊数量
- `adjustPrice()`: 调整价格
- `processPayment()`: 处理付款
- `settleOrder()`: 结算订单
- `completeOrder()`: 完成订单
- `cancelOrder()`: 取消订单

**物流协作方法：**
- `linkTransportTask()`: 关联运输任务
- `updateLogisticsStatus()`: 更新物流状态
- `linkVehicleWeighing()`: 关联车辆过磅

#### TransferOrderServiceImpl.java
业务逻辑实现类，实现了所有接口方法，包含：
- 完整的业务逻辑实现
- 状态校验和流程控制
- 数量和金额计算
- 分摊逻辑处理
- 事务管理
- 异常处理
- 日志记录

### 7. 控制器层 (Controller)

#### TransferOrderController.java
REST API 控制器，提供完整的 HTTP 接口：

**基础 CRUD 接口：**
- `POST /create`: 创建危废转移订单
- `PUT /update`: 更新危废转移订单
- `DELETE /delete`: 删除危废转移订单
- `GET /get`: 获取危废转移订单详情
- `GET /page`: 分页查询危废转移订单
- `GET /export-excel`: 导出 Excel

**查询接口：**
- `GET /get-by-order-no`: 根据订单号查询
- `GET /list-by-appointment-id`: 根据预约单ID查询
- `GET /list-by-enterprise-id`: 根据企业ID查询
- `GET /list-by-business-status`: 根据业务状态查询
- `GET /list-by-payment-status`: 根据付款状态查询
- `GET /list-by-waste-code`: 根据废物代码查询

**业务流程接口：**
- `PUT /confirm`: 确认订单
- `PUT /confirm-pickup`: 确认收货
- `PUT /allocate-quantity`: 分摊数量
- `PUT /adjust-price`: 调整价格
- `PUT /process-payment`: 处理付款
- `PUT /settle`: 结算订单
- `PUT /complete`: 完成订单
- `PUT /cancel`: 取消订单

**物流协作接口：**
- `PUT /link-transport-task`: 关联运输任务
- `PUT /update-logistics-status`: 更新物流状态
- `PUT /link-vehicle-weighing`: 关联车辆过磅

### 8. 错误码

在 `ErrorCodeConstants.java` 中添加了危废转移订单相关的错误码：
- `TRANSFER_ORDER_NOT_EXISTS`: 危废转移订单不存在
- `TRANSFER_ORDER_NO_DUPLICATE`: 订单号已存在
- `TRANSFER_ORDER_STATUS_NOT_*`: 各种状态校验错误
- `TRANSFER_ORDER_CANNOT_DELETE_*`: 删除权限控制错误
- `TRANSFER_ORDER_ALLOCATION_FAILED`: 分摊计算失败
- `TRANSFER_ORDER_PAYMENT_FAILED`: 付款处理失败

## 功能特点

### 1. 完整的业务流程
实现了危废转移订单从创建到完成的完整生命周期管理：
待确认 → 已确认 → 待结算 → 已结算 → 已完成

### 2. 多维度数量管理
- 预估数量：基于预约单的初始数量
- 确认数量：收运员现场确认的实际数量
- 分摊数量：基于车辆过磅数据的最终分摊数量

### 3. 灵活的分摊机制
- 支持多种分摊方法（按比例、人工指定、平均分摊）
- 自动计算分摊比例和金额
- 支持人工调整和异常处理

### 4. 完善的付款管理
- 支持多种付款方式（对公结算、个人结算）
- 完整的付款状态跟踪
- 付款凭证管理

### 5. 物流模块协作
- 与物流运输任务模块无缝集成
- 支持车辆过磅数据同步
- 物流状态实时更新

### 6. 数据完整性
- 订单号唯一性校验
- 状态流转校验
- 数量和金额一致性校验

### 7. 权限控制
- 细粒度的权限控制
- 不同角色的操作权限
- 敏感操作的审计跟踪

### 8. 审计日志
- 完整的状态变更历史
- 价格调整记录
- 分摊计算过程记录

## 使用说明

### 1. 权限配置
需要在系统中配置以下权限：
- `waste:transfer-order:create`: 创建权限
- `waste:transfer-order:update`: 更新权限
- `waste:transfer-order:delete`: 删除权限
- `waste:transfer-order:query`: 查询权限
- `waste:transfer-order:export`: 导出权限
- `waste:transfer-order:confirm`: 确认权限
- `waste:transfer-order:pickup`: 收货权限
- `waste:transfer-order:allocate`: 分摊权限
- `waste:transfer-order:adjust`: 调整权限
- `waste:transfer-order:payment`: 付款权限
- `waste:transfer-order:settle`: 结算权限
- `waste:transfer-order:complete`: 完成权限
- `waste:transfer-order:cancel`: 取消权限

### 2. 业务流程
1. 创建订单（从预约转换或直接创建）
2. 确认订单信息和价格
3. 关联物流运输任务
4. 收运员现场确认收货
5. 车辆过磅后进行数量分摊
6. 处理付款（根据付款配置）
7. 结算订单
8. 完成订单

### 3. 分摊计算
- 系统自动根据车辆过磅数据计算分摊比例
- 支持按预估量比例、确认量比例等多种方法
- 可进行人工调整和异常处理
- 自动计算差异率和调整金额

### 4. 付款管理
- 根据产废企业付款配置自动确定付款方式
- 支持对公结算和个人结算
- 完整的付款状态跟踪和凭证管理

## 技术规范遵循

1. **代码规范**：严格按照 ruoyi-vue-pro 的代码规范
2. **包结构**：遵循标准的分层架构
3. **命名规范**：使用统一的命名约定
4. **注解使用**：正确使用 Swagger、校验等注解
5. **异常处理**：统一的异常处理机制
6. **事务管理**：合理的事务边界控制
7. **日志记录**：完善的日志记录机制

## 与其他模块的集成

### 1. 与预约模块集成
- 订单可以从预约单转换生成
- 继承预约单的基础信息
- 支持预约状态同步更新

### 2. 与物流模块集成
- 关联物流运输任务
- 同步物流状态信息
- 集成车辆过磅数据

### 3. 与企业模块集成
- 关联产废企业和回收企业
- 获取企业付款配置
- 支持企业权限控制

### 4. 与报价模块集成
- 关联报价记录
- 继承报价信息
- 支持价格调整

### 5. 与付款模块集成
- 集成付款配置
- 支持多种付款方式
- 付款凭证管理

## 编译验证

所有代码已通过 Maven 编译验证，无编译错误，可以正常运行。

## 总结

本次开发完成了一个功能完整、业务逻辑清晰、技术架构合理的危废转移订单管理模块：

1. **业务完整性**：覆盖了危废转移订单的完整生命周期
2. **数据准确性**：多维度数量管理和精确的分摊计算
3. **集成能力强**：与多个业务模块无缝集成
4. **扩展性好**：支持多种业务场景和配置
5. **规范标准**：严格遵循项目规范，代码质量高

该模块为危废处理业务提供了强大的订单管理能力，支持复杂的业务流程和精确的数量、金额计算，是危废管理系统的核心组件。 